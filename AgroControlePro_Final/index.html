<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgroControle Pro</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;padding:0;background:#111;color:#fff;font-family:Arial;font-size:14px;}
h2{text-align:center;margin:5px 0;font-size:18px;}
.tab{display:flex;justify-content:space-around;background:#1e1e1e;}
.tab button{flex:1;padding:10px;border:none;background:#1e1e1e;color:#fff;font-weight:bold;cursor:pointer;font-size:14px;}
.tab button.active{background:#ff9800;color:#000;}
.section{display:none;padding:8px;}
.card{background:#1e1e1e;padding:8px;border-radius:8px;margin:5px;}
input,select,button{width:100%;padding:6px;margin:3px 0;border:none;border-radius:5px;font-size:14px;}
button{background:#ff9800;color:#000;font-weight:bold;cursor:pointer;}
.flex{display:flex;gap:5px;flex-wrap:wrap;}
.smallDelete{background:#e53935;width:40px;padding:4px;font-size:12px;}
.total{font-size:16px;margin-top:5px;}
canvas{background:#fff;border-radius:8px;width:100% !important;height:200px !important;}
table{width:100%;border-collapse:collapse;margin-top:5px;font-size:12px;}
th,td{border:1px solid #444;padding:3px;text-align:center;}
th{background:#333;}
@media(max-width:500px){.flex{flex-direction:column;}button,input,select{font-size:14px;padding:8px;}}
</style>
</head>
<body>

<h2>üåæ AgroControle Pro</h2>

<!-- Login -->
<div class="card" id="loginCard">
  <label>Nome do Usu√°rio:</label>
  <input type="text" id="usuarioInput" placeholder="Digite seu nome">
  <label>Administrador?</label>
  <select id="adminSelect">
    <option value="nao">N√£o</option>
    <option value="sim">Sim</option>
  </select>
  <button onclick="loginUsuario()">Entrar</button>
</div>

<!-- √Årea principal -->
<div id="mainApp" style="display:none;">

<div class="tab">
<button class="tablinks active" onclick="openTab(event,'tab1')">Fazenda & Produtos</button>
<button class="tablinks" onclick="openTab(event,'tab2')">Hist√≥rico & Admin</button>
</div>

<div id="tab1" class="section" style="display:block;">
  <!-- FAZENDA -->
  <div class="card">
    <label>Fazenda:</label>
    <select id="listaFazendas"></select>
    <input type="text" id="novaFazenda" placeholder="Nova fazenda">
    <div class="flex">
      <button onclick="criarNovaFazenda()">üíæ Criar/Selecionar</button>
      <button class="smallDelete" onclick="apagarFazenda()">üóëÔ∏è Apagar</button>
    </div>
  </div>

  <!-- PRODUTO -->
  <div class="card">
    <label>Novo Produto</label>
    <input type="text" id="novoProduto" placeholder="Digite novo produto">
    <select id="listaProdutosGlobais"></select>
    <button onclick="criarProduto()">Adicionar Produto</button>
  </div>

  <!-- PRODUTO SELECIONADO -->
  <div id="produtoDetalhes" class="card" style="display:none;">
    <label>Selecionar Produto da fazenda</label>
    <div class="flex">
      <select id="listaProdutos" style="flex:1" onchange="selecionarProduto()"></select>
      <button class="smallDelete" onclick="excluirProduto()">X</button>
    </div>

    <label>Quantidade (Estoque)</label>
    <input type="number" id="quantidade" min="0">

    <div class="flex">
      <button style="flex:1" onclick="retirado()">Retirado</button>
      <button style="flex:1" onclick="aplicado()">Aplicado</button>
    </div>

    <button onclick="desfazerEstoque()">Desfazer √öltima Movimenta√ß√£o</button>

    <hr>

    <label>Dose Aplicada</label>
    <input type="number" id="dose" min="0">
    <label>√Årea Aplicada (ha)</label>
    <input type="number" id="area" min="0" oninput="calcularDose()">
    <label>Qtd/ha</label>
    <input type="number" id="hectare" readonly>
    <div class="flex">
      <button style="flex:1" onclick="registrarAplicacao()">Registrar Aplica√ß√£o</button>
      <button style="flex:1" onclick="desfazerAplicacao()">Desfazer Aplica√ß√£o</button>
    </div>
  </div>

  <div class="card">
    <div class="total">Estoque Atual: <span id="estoque">0.00</span></div>
    <div class="total">M√©dia por Hectare: <span id="media">0.00</span></div>
  </div>
</div>

<div id="tab2" class="section">
  <div class="card">
    <h3>üìã Hist√≥rico</h3>
    <table>
      <thead>
        <tr><th>Usu√°rio</th><th>Fazenda</th><th>Produto</th><th>Tipo</th><th>Qtd</th><th>Dose</th><th>√Årea</th><th>Qtd/Ha</th><th>Data</th><th>Excluir</th></tr>
      </thead>
      <tbody id="tabelaHistorico"></tbody>
    </table>
  </div>

  <div class="card" id="usuariosLista">
    <h3>üë§ Usu√°rios (Admin)</h3>
  </div>

  <div class="card">
    <h3>üìä Distribui√ß√£o</h3>
    <canvas id="graficoCanvas"></canvas>
  </div>

  <div class="card">
    <h3>üíæ Backup</h3>
    <button onclick="baixarBackup()">Fazer Backup</button>
    <input type="file" id="arquivoBackup" accept=".json" onchange="restaurarBackup(event)">
  </div>
</div>

<script>
// ---------- Firebase ----------
const firebaseConfig = {
  apiKey: "AIzaSyDqgk71ZIeNxEHsyBQkWJjjYGkaunmkBEk",
  authDomain: "agrocontrolepro.firebaseapp.com",
  projectId: "agrocontrolepro",
  storageBucket: "agrocontrolepro.firebasestorage.app",
  messagingSenderId: "519100859803",
  appId: "1:519100859803:web:3c3ddc3b610d60df338d3e",
  measurementId: "G-1WQGZYFB89"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------- Vari√°veis ----------
let usuario="", admin=false, nomeFazenda="", produtos={}, produtoAtual=null, produtosGlobais=[], chart=null;

// ---------- Abas ----------
function openTab(evt, tabName){
  document.querySelectorAll(".section").forEach(s=>s.style.display="none");
  document.getElementById(tabName).style.display="block";
  document.querySelectorAll(".tablinks").forEach(b=>b.classList.remove("active"));
  evt.currentTarget.classList.add("active");
}

// ---------- Login ----------
function loginUsuario(){
  usuario = document.getElementById("usuarioInput").value.trim();
  admin = document.getElementById("adminSelect").value==="sim";
  if(!usuario){ alert("Digite seu nome"); return; }
  document.getElementById("loginCard").style.display="none";
  document.getElementById("mainApp").style.display="block";
  carregarProdutosGlobais(); carregarListaFazendas();
}

// ---------- Fazendas ----------
function carregarListaFazendas(){
  db.collection("fazendas").get().then(snap=>{
    const select = document.getElementById("listaFazendas");
    select.innerHTML='<option value="">--Selecione--</option>';
    snap.forEach(doc=>{
      const opt=document.createElement("option");
      opt.value=doc.id; opt.text=doc.id; select.appendChild(opt);
    });
  });
}

function criarNovaFazenda(){
  let f=document.getElementById("novaFazenda").value.trim();
  if(!f){ alert("Digite ou selecione"); return; }
  nomeFazenda=f;
  db.collection("fazendas").doc(nomeFazenda).set({createdBy:usuario});
}

// ---------- Produtos Globais ----------
function carregarProdutosGlobais(){
  db.collection("produtosGlobais").get().then(snap=>{
    produtosGlobais=[]; const sel=document.getElementById("listaProdutosGlobais");
    sel.innerHTML='<option value="">--Sugest√£o Global--</option>';
    snap.forEach(doc=>{
      produtosGlobais.push(doc.id);
      const opt=document.createElement("option");
      opt.value=doc.id; opt.text=doc.id; sel.appendChild(opt);
    });
  });
}

function criarProduto(){
  const nome=document.getElementById("novoProduto").value.trim() || document.getElementById("listaProdutosGlobais").value.trim();
  if(!nome || !nomeFazenda) return;
  db.collection("produtosGlobais").doc(nome).set({createdBy:usuario});
  db.collection("fazendas").doc(nomeFazenda).collection("produtos").doc(nome).set({estoque:0,historico:[]});
  produtoAtual=nome;
  atualizarLista();
  document.getElementById("novoProduto").value="";
}

function atualizarLista(){
  if(!nomeFazenda) return;
  db.collection("fazendas").doc(nomeFazenda).collection("produtos").get().then(snap=>{
    const sel=document.getElementById("listaProdutos");
    sel.innerHTML="";
    snap.forEach(doc=>{
      const opt=document.createElement("option");
      opt.value=doc.id; opt.text=doc.id; sel.appendChild(opt);
    });
    produtoAtual = sel.value || null;
    toggleProdutoDetalhes();
    carregarHistorico();
  });
}

function selecionarProduto(){
  produtoAtual=document.getElementById("listaProdutos").value;
  toggleProdutoDetalhes();
  carregarHistorico();
}

function toggleProdutoDetalhes(){
  document.getElementById("produtoDetalhes").style.display = produtoAtual?"block":"none";
}

function excluirProduto(){
  if(!produtoAtual || !nomeFazenda) return;
  if(confirm("Excluir este produto?")){
    db.collection("fazendas").doc(nomeFazenda).collection("produtos").doc(produtoAtual).delete();
    produtoAtual=null;
    atualizarLista();
  }
}

// ---------- Movimenta√ß√µes ----------
function limparCampos(){
  document.getElementById("quantidade").value="";
  document.getElementById("dose").value="";
  document.getElementById("area").value="";
  document.getElementById("hectare").value="";
}

function calcularDose(){
  let dose=Number(document.getElementById("dose").value);
  let area=Number(document.getElementById("area").value);
  document.getElementById("hectare").value=(dose>0 && area>0)?(dose/area).toFixed(2):"";
}

function retirado(){
  let qtd=Number(document.getElementById("quantidade").value);
  if(!produtoAtual || qtd<=0) return;
  db.collection("fazendas").doc(nomeFazenda).collection("produtos").doc(produtoAtual).get().then(doc=>{
    let estoque=doc.data().estoque||0; let hist=doc.data().historico||[];
    estoque+=qtd; hist.push({tipo:"Retirado",qtd:dose||qtd,usuario,data:new Date().toLocaleString()});
    db.collection("fazendas").doc(nomeFazenda).collection("produtos").doc(produtoAtual).update({estoque,historico:hist});
    limparCampos(); carregarHistorico();
  });
}

function aplicado(){
  let qtd=Number(document.getElementById("quantidade").value);
  if(!produtoAtual || qtd<=0) return;
  document.getElementById("dose").value=qtd; // quantidade vai para dose
  calcularDose();
  db.collection("fazendas").doc(nomeFazenda).collection("produtos").doc(produtoAtual).get().then(doc=>{
    let estoque=doc.data().estoque||0; let hist=doc.data().historico||[];
    estoque-=qtd; hist.push({tipo:"Aplicado",qtd:qtd,usuario,data:new Date().toLocaleString()});
    db.collection("fazendas").doc(nomeFazenda).collection("produtos").doc(produtoAtual).update({estoque,historico:hist});
    limparCampos(); carregarHistorico();
  });
}

function registrarAplicacao(){
  let dose=Number(document.getElementById("dose").value);
  let area=Number(document.getElementById("area").value);
  let porHectare=Number(document.getElementById("hectare").value);
  if(!produtoAtual || dose<=0 || area<=0) return;
  db.collection("fazendas").doc(nomeFazenda).collection("produtos").doc(produtoAtual).get().then(doc=>{
    let hist=doc.data().historico||[];
    hist.push({tipo:"Aplica√ß√£o T√©cnica",dose,area,porHectare,usuario,data:new Date().toLocaleString()});
    db.collection("fazendas").doc(nomeFazenda).collection("produtos").doc(produtoAtual).update({historico:hist});
    limparCampos();
    carregarHistorico();
  });
}

// ---------- Hist√≥rico e gr√°fico ----------
function carregarHistorico(){
  const tbody=document.getElementById("tabelaHistorico");
  tbody.innerHTML="";
  let data=[0,0,0];
  db.collection("fazendas").get().then(fazendas=>{
    let totalEstoque=0, totalPorHa=0, countPorHa=0;
    const usuariosSet=new Set();
    fazendas.forEach(faz=>{
      const fName=faz.id;
      faz.ref.collection("produtos").get().then(prods=>{
        prods.forEach(prod=>{
          const pName=prod.id; const d=prod.data();
          (d.historico||[]).forEach((h,i)=>{
            if(!admin && h.usuario!==usuario) return;
            let tr=document.createElement("tr");
            tr.innerHTML=`<td>${h.usuario}</td><td>${fName}</td><td>${pName}</td><td>${h.tipo}</td><td>${h.qtd||""}</td><td>${h.dose||""}</td><td>${h.area||""}</td><td>${h.porHectare||""}</td><td>${h.data}</td>`;
            let tdBtn=document.createElement("td");
            let btn=document.createElement("button"); btn.className="smallDelete"; btn.innerText="X";
            btn.onclick=()=>{ if(confirm("Excluir registro?")){ d.historico.splice(i,1); prod.ref.update({historico:d.historico}); carregarHistorico(); } };
            tdBtn.appendChild(btn); tr.appendChild(tdBtn); tbody.appendChild(tr);
            if(h.tipo==="Retirado") data[0]+=Number(h.qtd||0);
            if(h.tipo==="Aplicado") data[1]+=Number(h.qtd||0);
          });
          totalEstoque+=d.estoque||0;
          if(d.historico) d.historico.forEach(h=>{ if(h.porHectare){totalPorHa+=Number(h.porHectare); countPorHa++;} });
        });
        document.getElementById("estoque").innerText=totalEstoque.toFixed(2);
        document.getElementById("media").innerText=countPorHa>0?(totalPorHa/countPorHa).toFixed(2):"0.00";
        data[2]=totalEstoque;
        atualizarGrafico(data);

        // ---------- Lista usu√°rios admin ----------
        if(admin){
          const usuariosDiv=document.getElementById("usuariosLista");
          usuariosDiv.innerHTML="<strong>Usu√°rios ativos:</strong><br>";
          usuariosSet.clear();
          fazendas.forEach(f=>{
            f.ref.collection("produtos").get().then(prods=>{
              prods.forEach(prod=>{
                (prod.data().historico||[]).forEach(h=>{ usuariosSet.add(h.usuario); });
              });
              usuariosDiv.innerHTML=Array.from(usuariosSet).join(", ");
            });
          });
        }

      });
    });
  });
}

function atualizarGrafico(data){
  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("graficoCanvas"),{
    type:"doughnut",
    data:{labels:["Retirado","Aplicado","Estoque"],datasets:[{data}]},
    options:{responsive:true}
  });
}

// ---------- Backup ----------
function baixarBackup(){
  let data={fazenda:nomeFazenda,produtos};
  let blob=new Blob([JSON.stringify(data)],{type:"application/json"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`backup_${nomeFazenda}.json`;
  a.click();
}

function restaurarBackup(e){
  let file=e.target.files[0];
  let reader=new FileReader();
  reader.onload=function(ev){
    let data=JSON.parse(ev.target.result);
    if(data.fazenda) nomeFazenda=data.fazenda;
    if(data.produtos) produtos=data.produtos;
    atualizarLista(); carregarHistorico();
  };
  reader.readAsText(file);
}

// ---------- Inicializa√ß√£o ----------
window.onload=function(){};
</script>
</body>
</html>
